# Privacy Test Container
# Uses oven/bun:1.3.5 to match project's Bun runtime (packageManager in package.json)
# Per ADR-TEST-001: Use Bun base image to avoid test/production mismatch

FROM oven/bun:1.3.5

WORKDIR /app

# Copy package files first for layer caching
# Must include all workspace package.json files for proper monorepo dependency resolution
COPY package.json bun.lock ./
COPY apps/web/package.json ./apps/web/
COPY apps/fumadocs/package.json ./apps/fumadocs/
COPY packages/api/package.json ./packages/api/
COPY packages/auth/package.json ./packages/auth/
COPY packages/config/package.json ./packages/config/
COPY packages/inference/package.json ./packages/inference/
COPY packages/platform/package.json ./packages/platform/

# Install dependencies (requires network - done during build)
# Note: --frozen-lockfile removed due to platform-specific lockfile differences
# Dependencies still follow lockfile versions
# --ignore-scripts skips postinstall (fumadocs doesn't need it for privacy tests)
RUN bun install --ignore-scripts

# Copy source code
COPY . .

# Set environment variable to enable network isolation tests
ENV PRIVACY_GATE_CI=true

# Run privacy gate tests
# These tests verify no network calls occur in local-only mode
CMD ["bun", "run", "test:privacy-gate"]
