name: Tauri Desktop Build

on:
  push:
    branches: [main]
    paths:
      - "apps/web/**"
      - "packages/**"
      - ".github/workflows/tauri-desktop-build.yml"
  pull_request:
    branches: [main]
    paths:
      - "apps/web/**"
      - "packages/**"
      - ".github/workflows/tauri-desktop-build.yml"
  workflow_dispatch:
    inputs:
      build_cuda:
        description: "Build with CUDA support (requires self-hosted runner with GPU)"
        required: false
        default: "false"
        type: boolean

env:
  BUN_VERSION: "1.3.5"
  RUST_VERSION: "1.92.0"

jobs:
  build-linux:
    name: Build Linux (CPU)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/web/src-tauri

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0"

      - name: Install frontend dependencies
        run: bun install --frozen-lockfile

      - name: Build Tauri app (CPU)
        working-directory: apps/web
        run: cargo tauri build
        env:
          TAURI_ENV_PLATFORM: linux

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: continuum-linux-cpu
          path: |
            apps/web/src-tauri/target/release/bundle/deb/*.deb
            apps/web/src-tauri/target/release/bundle/rpm/*.rpm
            apps/web/src-tauri/target/release/bundle/appimage/*.AppImage
          retention-days: 7

  build-macos:
    name: Build macOS
    # Using macos-13 (Intel x86_64) to avoid ring crate ARM64 Darwin compilation issues
    # See: https://github.com/briansmith/ring/issues/1442
    # TODO: Switch back to macos-latest when ring is fixed for ARM64
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/web/src-tauri

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0"

      - name: Install frontend dependencies
        run: bun install --frozen-lockfile

      - name: Build Tauri app
        working-directory: apps/web
        run: cargo tauri build
        env:
          TAURI_ENV_PLATFORM: darwin

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: continuum-macos
          path: |
            apps/web/src-tauri/target/release/bundle/macos/*.app
            apps/web/src-tauri/target/release/bundle/dmg/*.dmg
          retention-days: 7

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/web/src-tauri

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0"

      - name: Install frontend dependencies
        run: bun install --frozen-lockfile

      - name: Build Tauri app
        working-directory: apps/web
        run: cargo tauri build
        env:
          TAURI_ENV_PLATFORM: windows

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: continuum-windows
          path: |
            apps/web/src-tauri/target/release/bundle/msi/*.msi
            apps/web/src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 7

  # CUDA build requires self-hosted runner with NVIDIA GPU
  # build-linux-cuda:
  #   name: Build Linux (CUDA)
  #   runs-on: self-hosted
  #   if: ${{ github.event.inputs.build_cuda == 'true' }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Build with CUDA
  #       working-directory: apps/web
  #       run: cargo tauri build --features cuda
  #       env:
  #         TAURI_ENV_PLATFORM: linux
